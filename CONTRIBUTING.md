# Contributing Guide

Thank you for considering a contribution! This project follows a simple trunk-based workflow.

## Using GitHub Copilot

This repository is configured for optimal use with GitHub Copilot. Please follow these guidelines:

### Copilot Best Practices

- **Review suggestions carefully**: Always review and understand Copilot suggestions before accepting them
- **Test generated code**: All Copilot-generated code must be tested locally before committing
- **Security awareness**: Never accept suggestions that include hardcoded secrets, API keys, or sensitive data
- **Context matters**: Ensure Copilot has proper context by keeping related files open in your editor
- **Follow repository patterns**: Copilot works best when you maintain consistency with existing code patterns

### Repository-Specific Copilot Guidelines

- **TypeScript strict mode**: Ensure Copilot suggestions maintain strict typing (no `any` types)
- **Model consistency**: When working with Mongoose models, follow existing schema patterns in `lib/db/models/`
- **Security-first**: Review all authentication, encryption, and validation code generated by Copilot
- **Logging standards**: Use the Winston logger from `lib/utils/logger.ts` for all logging
- **Environment variables**: Only use `process.env` for configuration; never hardcode values

### Copilot Instructions

The repository includes comprehensive Copilot instructions in `.github/copilot-instructions.md` covering:
- Repository structure and tech stack
- Coding standards and patterns
- Security requirements
- Common development tasks

Refer to this file for detailed guidance on how Copilot should assist in this project.

### Advanced Copilot Features

This repository includes advanced Copilot configuration for enhanced productivity:

#### Path-Specific Instructions

Different code areas have targeted guidance in `.github/instructions/`:
- **Database models** (`lib/db/models/`) - Schema patterns, encryption, indexes
- **Middleware** (`lib/middleware/`) - Express patterns, auth, rate limiting
- **Services** (`lib/services/`) - Meta API integration, retry logic, caching
- **Security files** - Extra security requirements for auth and encryption
- **Test scripts** (`scripts/`) - Test patterns, cleanup, exit codes

Copilot automatically applies the relevant instructions based on which file you're editing.

#### Specialized Agent Personas

For complex tasks, invoke specialized agents from `.github/agents/`:
- **Database Specialist** - Expert in MongoDB, Mongoose, schema design
- **Security Specialist** - Expert in auth, encryption, security best practices
- **Meta API Specialist** - Expert in Graph API, campaigns, optimization

Agents provide focused expertise and run appropriate tests for their domain.

#### Environment Setup for Copilot Agents

The workflow `.github/workflows/copilot-setup-steps.yml` pre-configures the environment:
- Installs dependencies with `npm ci`
- Starts Docker services (MongoDB, Redis)
- Waits for services to be healthy
- Ensures agents can start working immediately

This reduces setup time and improves agent effectiveness when working on tasks.

### How to Use Path-Specific Instructions

1. Open a file in the relevant directory (e.g., `lib/db/models/campaign.ts`)
2. Copilot automatically loads the matching instructions
3. Suggestions follow the specific patterns for that code area
4. Instructions are layered with repository-wide guidance

### When to Use Agent Personas

Use specialized agents for:
- **Database Agent**: Creating new models, optimizing queries, adding indexes
- **Security Agent**: Implementing authentication, encryption, security reviews
- **Meta API Agent**: Integrating Graph API, handling webhooks, optimization logic

Agents stay within their boundaries and defer to other specialists when needed.

## Branch Strategy

- Default branch: `main`
- Use short-lived feature branches: `feature/<short-name>`
- Open a PR into `main` and prefer squash merges

## Commit & PR Hygiene

- Use clear, descriptive commit messages (Conventional Commits are welcome)
- Keep PRs small and focused; include context and test evidence
- Link issues when applicable

## CI Requirements

- CI runs lint, typecheck, build, and tests
- PRs must pass required checks before merge
- Secrets must never be committed; use GitHub Actions secrets for CI

## Local Setup

- Copy `.env.example` to `.env` and fill values
- Use Docker Compose to start MongoDB and Redis
- Run test scripts:
  - `npm run test:security`
  - `npm run test:auth`
  - `npm run test:rate`

## Testing AI-Generated Code

When using GitHub Copilot or other AI assistants:

- **Always test locally**: Run relevant test scripts before committing
- **Test script coverage**: Use `npm run test:all` to run the full test suite
- **Manual verification**: For database changes, use `npm run test:db` to verify schema sync
- **Security validation**: Run `npm run test:security` for encryption and authentication changes
- **Integration testing**: Test end-to-end flows, not just unit tests

If you add new functionality, create corresponding test scripts in the `scripts/` directory following the existing patterns.

## Code Style & Types

- TypeScript strict preferred; avoid `any` when possible
- Use Zod for input validation in new endpoints
- Keep logging structured via the provided logger utilities

## Security & Code Quality

### Security Requirements

- **No secrets in code**: Never commit API keys, tokens, passwords, or other secrets
- **Environment variables only**: Use `.env` files (excluded from git) for sensitive configuration
- **Encryption at rest**: Sensitive data (Meta tokens, API keys) must be encrypted using `lib/utils/crypto.ts`
- **Input validation**: All user inputs must be validated using Zod schemas
- **Authentication**: Use JWT middleware from `lib/middleware/auth.ts` for protected routes
- **Rate limiting**: Apply rate limiting middleware to prevent abuse
- **Dependency security**: Review dependencies for known vulnerabilities before adding them

### Pre-Commit Checklist

Before committing code, verify:
- [ ] No hardcoded secrets or sensitive data
- [ ] All environment variables are documented in `.env.example`
- [ ] Sensitive data is encrypted using the crypto utility
- [ ] Input validation is implemented for new endpoints
- [ ] Error messages don't leak sensitive information
- [ ] Logging doesn't include PII, tokens, or passwords
- [ ] TypeScript types are properly defined (no `any`)
- [ ] Code follows existing patterns and conventions

### Code Review Focus Areas

When reviewing PRs, pay special attention to:
- Security vulnerabilities and data exposure risks
- Proper error handling and logging
- TypeScript type safety
- Database query performance and indexing
- Redis caching strategies
- Authentication and authorization logic

## Review & Merge

- At least one approval required
- Rebase or squash to keep history clean
- Branches are auto-deleted after merge

## Release & Deployment

- Merges to `main` go to staging; tagged releases deploy to production (if configured)
- Use feature flags for risky changes when possible
